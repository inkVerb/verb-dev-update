#!/bin/sh
# inkVerb updater for Verber™, verb.ink

#set -e

# This "updates" the serfs and "upgrades" Verber
## serfs are updated every time. Upgrades only relate to Verber framework which has verber version numbers related to each patch/release.
## This contains many version patches for a Verber™ sequentially, one version at a time.
## This is run at the path: /opt/verb/${VUPDATE_REPO}/update

# To call a changelog for a specific version, use: `/bin/echo "$vCLEANVERNO"` Eg: `echo "$v08702"` for v0.87.02

# DEV NOTE: A directory, even empty, must exist in the same directory as this "update" file named by by each update version ie: 0.87.01/

# DEV NOTE: Larger versions must be at the bottom, smaller versions at the top, so "descending"

# DEV INSTRUCTIONS: Put all related files for each patch in a folder named by the version number, ie: 0.87.01/

# DEV NOTE: Serfs are automatically copied & updated from ${VUPDATE_REPO}/serfs to the Verber before any patches run, after the verno check.


MIN_VERNO=0.88.01
VUPDATE_REPO="verb-dev-update"

## Sample version updater:
#UPGRADE_PATCH_VERNO=0.88.02
#if [ $(/bin/echo ${UPGRADE_PATCH_VERNO} | /bin/sed -e "s/\.//g" | /bin/sed -e "s/^0*//g") -gt $(/bin/echo ${VERNO} | /bin/sed -e "s/\.//g" | /bin/sed -e "s/^0*//g") ] ; then
#CLEAN_PATCH_VERNO=$(/bin/echo $UPGRADE_PATCH_VERNO | /bin/sed -e "s/\.//g")
#PCLdoc="$(/bin/cat <<UPCL
#Patch ${UPGRADE_PATCH_VERNO} Changelog:
### Patch Notes Here...
#UPCL
#)"
#/bin/echo "$PCLdoc"
## So we can call a specific version later if needed
#eval "v$CLEAN_PATCH_VERNO='$(/bin/echo "$PCLdoc")'"
#
## Move to working directory of the patch
#if [ -d "/opt/verb/${VUPDATE_REPO}/${UPGRADE_PATCH_VERNO}/" ]; then
#cd /opt/verb/${VUPDATE_REPO}/${UPGRADE_PATCH_VERNO}/; fi
#
## Run the update scripts for this patch
#
###### SCRIPTS GO HERE #####
## NOTE: PWD is /opt/verb/${VUPDATE_REPO}/${UPGRADE_PATCH_VERNO}/
#
## eg: /bin/echo "I would update the serfs here, but that happens automatically."
#
#
#
###### END SCRIPTS #########
## Set and refresh the current version into inklists
#/bin/sed -i "s/VERNO=.*/VERNO=\"${UPGRADE_PATCH_VERNO}\"/g" /opt/verb/conf/inklists/verberverno
#. /opt/verb/conf/inklists/verberverno
#/bin/echo "Verber upgraded to v${VERNO}"
#else
#/bin/echo "${UPGRADE_PATCH_VERNO} patch not necessary..."
#fi
###############END#UPGRADE#PATCH#


## Version Check ##
### The minimum version that can use this updater
## Include the configs
. /opt/verb/conf/sitenameip
. /opt/verb/conf/siteurilist
. /opt/verb/conf/inklists/verberverno
## Check minimal updateable version
if [ $(/bin/echo ${MIN_VERNO} | /bin/sed -e "s/\.//g" | /bin/sed -e "s/^0*//g") -gt $(/bin/echo ${VERNO} | /bin/sed -e "s/\.//g" | /bin/sed -e "s/^0*//g") ] ; then
/bin/echo "Current Verber™ version is ${VERNO}, minimum ${MIN_VERNO} to use this updater.
Run updateverberlegacy for older versions."
exit 0
fi

# Update Serfs
/bin/rm -f /opt/verb/serfs/*
/bin/cp /opt/verb/${VUPDATE_REPO}/serfs/* /opt/verb/serfs/
/bin/chmod 750 /opt/verb/serfs/*
/bin/chmod 750 /opt/verb/donjon/*.sh
cd /opt/verb
/bin/rm -f README.md
/usr/bin/wget https://raw.githubusercontent.com/inkVerb/verb-dev/master/README.md
/bin/echo "Serfs have been updated."

# Update inkLists
## inkGet
. /opt/verb/conf/siteinkget
if [ "${INKGET_LIST}" = "AUTO_UPDATE" ]; then
/bin/cp /opt/verb/${VUPDATE_REPO}/inklists/repoverlist /opt/verb/conf/inklists/
/bin/cp /opt/verb/${VUPDATE_REPO}/inklists/repolinks /opt/verb/conf/inklists/
/bin/cp /opt/verb/${VUPDATE_REPO}/inkdns/inkdnsconf /opt/verb/conf/inkdns/
/bin/echo "Repo version list is up-to-date."
else
/bin/echo "Repo version list unchanged because this is a custom Verber."
fi

# Run version-by-version updates


#UPGRADE_PATCH_VERNO=0.88.02
#if [ $(/bin/echo ${UPGRADE_PATCH_VERNO} | /bin/sed -e "s/\.//g" | /bin/sed -e "s/^0*//g") -gt $(/bin/echo ${VERNO} | /bin/sed -e "s/\.//g" | /bin/sed -e "s/^0*//g") ] ; then
#CLEAN_PATCH_VERNO=$(/bin/echo $UPGRADE_PATCH_VERNO | /bin/sed -e "s/\.//g")
#PCLdoc="$(/bin/cat <<UPCL
#Patch ${UPGRADE_PATCH_VERNO} Changelog:
### Patch Notes Here...
#UPCL
#)"
#/bin/echo "$PCLdoc"
## So we can call a specific version later if needed
#eval "v$CLEAN_PATCH_VERNO='$(/bin/echo "$PCLdoc")'"
#
## Move to working directory of the patch
#if [ -d "/opt/verb/${VUPDATE_REPO}/${UPGRADE_PATCH_VERNO}/" ]; then
#cd /opt/verb/${VUPDATE_REPO}/${UPGRADE_PATCH_VERNO}/; fi
#
## Run the update scripts for this patch
#
###### SCRIPTS GO HERE #####
## NOTE: PWD is /opt/verb/${VUPDATE_REPO}/${UPGRADE_PATCH_VERNO}/
#
## eg: /bin/echo "I would update the serfs here, but that happens automatically."
#
#
#
###### END SCRIPTS #########
## Set and refresh the current version into inklists
#/bin/sed -i "s/VERNO=.*/VERNO=\"${UPGRADE_PATCH_VERNO}\"/g" /opt/verb/conf/inklists/verberverno
#. /opt/verb/conf/inklists/verberverno
#/bin/echo "Verber upgraded to v${VERNO}"
#else
#/bin/echo "${UPGRADE_PATCH_VERNO} patch not necessary..."
#fi
###############END#UPGRADE#PATCH#


# Security check
/opt/verb/serfs/setsecure; wait

# Finish
/bin/echo "Verber at v${VERNO} framework from ${SITEUPDATEREPO}."
